name: Manual Branch Build

on:
    pull_request:
        branches:
            - master
    workflow_dispatch:
        inputs:
            branch:
                description: 'Branch to build'
                required: true
                default: 'main'

jobs:
    build:
        runs-on: self-hosted
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2
            with:
              ref: ${{ github.event.inputs.branch }}
          - name: Clone performance-common repository
            run: git clone --branch ballerina-patch https://github.com/heshanpadmasiri/performance-common.git performance-common
          - name: Set up Java
            run: echo "JAVA_HOME=/home/ubuntu/jdk/jdk-17.0.13+11" >> $GITHUB_ENV
          - name: Build with make dist
            run: make KEY_FILE_PREFIX=/home/ubuntu/key-files PERFORMANCE_COMMON_PATH=./performance-common dist
          - name: unpack test distribution
            run: mkdir -p test-dist && tar -xzf ./build/dist.tar.gz -C test-dist
          - name: unpack ballerina-performance
            run : tar -xzf ./test-dist/ballerina-performance-*.tar.gz -C test-dist
          - name: Setup common path prefix
            run: echo "PERF_PREFIX=/home/ubuntu/perf" >> $GITHUB_ENV
          - name: Dissable AWS pager
            run: echo "AWS_PAGER=" >> $GITHUB_ENV
          - name: run test
            run: cd test-dist/ballerina-performance-distribution-1.1.1-SNAPSHOT/runner/ && python3 main.py
